#!/usr/bin/env bash
# whoami with user as argument


#sudo useradd -s /sbin/nologin -r -M nginx
#sudo groupadd -r nginx

#sudo sed -i 's/listen 80/default_server;listen 8080;/g' /etc/nginx/sites-available/default

#sudo sed -i 's/server_name  localhost;/server_name _;/g' /etc/nginx/nginx.conf



# Create nginx user if not exists
if ! id -u nginx &> /dev/null; then
  useradd -r -d /var/www -s /sbin/nologin nginx
fi

# Modify the Nginx configuration to run as nginx user and listen on port 8080
NGINX_CONF="/etc/nginx/nginx.conf"
if [ -f "$NGINX_CONF" ]; then
  sed -i 's/^user .*/user nginx;/' "$NGINX_CONF"
  sed -i 's/listen 80;/listen 8080;/' /etc/nginx/sites-available/default
else
  echo "Nginx configuration file not found" >&2
  exit 1
fi

# Change ownership of necessary directories
chown -R nginx:nginx /var/log/nginx
chown -R nginx:nginx /var/lib/nginx
chown -R nginx:nginx /var/www

# Allow nginx to bind to port 8080
setcap 'cap_net_bind_service=+ep' /usr/sbin/nginx

# Restart Nginx to apply changes
systemctl restart nginx

# Verify Nginx is running as the nginx user
ps aux | grep nginx | grep -v grep

echo "Nginx has been configured to run as the nginx user and listen on port 8080."
